services:
  base:
    build:
      context: ..
      dockerfile: ./docker/Dockerfile
    image: mycomai-rag
    env_file:
      - ../.env
    volumes:
      - ../chroma_db:/app/chroma_db
      - ../src/company_llm_rag:/app/company_llm_rag
    networks:
      - me

  data-loader:
    extends:
      service: base
    volumes:
      - ../data:/app/data
    command: >
      bash -c "
        echo 'Starting data extraction...' &&
        python3 company_llm_rag/data_extraction/jira/jira_extractor.py 2> data/jira_errors.log > data/jira_data.jsonl &&
        python3 company_llm_rag/data_extraction/confluence/confluence_extractor.py 2> data/confluence_errors.log > data/confluence_data.jsonl &&
        python3 company_llm_rag/data_extraction/m365/sharepoint_extractor.py 2> data/sharepoint_errors.log > data/sharepoint_data.jsonl &&
        python3 company_llm_rag/data_extraction/m365/teams_extractor.py 2> data/teams_errors.log > data/teams_data.jsonl &&
        echo 'Data extraction complete. Starting data loading...' &&
        cat data/jira_data.jsonl data/confluence_data.jsonl data/sharepoint_data.jsonl data/teams_data.jsonl | python3 company_llm_rag/data_loader.py &&
        echo 'Data loading complete!'
      "

  rag-system:
    extends:
      service: base
    command: python3 company_llm_rag/rag_system.py
    stdin_open: true
    tty: true

  cron-scheduler:
    extends:
      service: base
    volumes:
      - ../data:/app/data
      - ./crontab:/etc/cron.d/my-cron
      - ./cron-entrypoint.sh:/app/cron-entrypoint.sh
    entrypoint: /bin/bash /app/cron-entrypoint.sh
    user: root
    restart: always

networks:
  me:
    driver: bridge

volumes:
  chroma_db:
    driver: local
  host_data:
    driver: local
